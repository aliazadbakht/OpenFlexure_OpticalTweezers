<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Optical Tweezers Microrheology Simulation</title>

    <!-- PyScript CSS -->
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>

    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            min-height: 100vh;
            color: #e2e8f0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(30, 41, 59, 0.8);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            border: 1px solid rgba(148, 163, 184, 0.1);
            backdrop-filter: blur(10px);
        }

        h1 {
            background: linear-gradient(90deg, #22d3ee, #3b82f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
            margin-bottom: 5px;
            font-size: 2.2em;
            font-weight: 700;
        }

        .subtitle {
            text-align: center;
            color: #94a3b8;
            margin-bottom: 25px;
            font-size: 1.1em;
        }

        .top-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
            justify-content: center;
            align-items: center;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-group label {
            color: #cbd5e1;
            font-weight: 500;
            font-size: 0.95em;
        }

        select {
            padding: 10px 15px;
            border-radius: 10px;
            border: 1px solid rgba(148, 163, 184, 0.3);
            background: rgba(15, 23, 42, 0.8);
            color: #e2e8f0;
            font-size: 0.95em;
            cursor: pointer;
            min-width: 220px;
            transition: all 0.2s;
        }

        select:hover {
            border-color: #3b82f6;
            background: rgba(15, 23, 42, 0.95);
        }

        select:focus {
            outline: none;
            border-color: #22d3ee;
            box-shadow: 0 0 0 3px rgba(34, 211, 238, 0.2);
        }

        .info-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .info-card {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.15);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
        }

        .info-card .label {
            font-size: 0.8em;
            color: #94a3b8;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-card .value {
            font-size: 1.4em;
            font-weight: 600;
            font-family: 'Consolas', 'Monaco', monospace;
        }

        .info-card.gprime .value { color: #22c55e; }
        .info-card.gdoubleprime .value { color: #f97316; }
        .info-card.eta .value { color: #a855f7; }
        .info-card.tau .value { color: #eab308; }

        .instructions {
            background: rgba(34, 211, 238, 0.1);
            border-left: 4px solid #22d3ee;
            padding: 15px 20px;
            margin-bottom: 20px;
            border-radius: 0 10px 10px 0;
        }

        .instructions h3 {
            margin-top: 0;
            color: #22d3ee;
            font-size: 1em;
        }

        .instructions ul {
            margin: 10px 0 0 0;
            padding-left: 20px;
            color: #cbd5e1;
        }

        .instructions li {
            margin: 5px 0;
            font-size: 0.9em;
        }

        .instructions code {
            background: rgba(15, 23, 42, 0.6);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.85em;
            color: #22d3ee;
        }

        #plot-area {
            width: 100%;
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: #22d3ee;
            font-size: 1.2em;
        }

        .spinner {
            border: 4px solid rgba(148, 163, 184, 0.2);
            border-top: 4px solid #22d3ee;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .footer {
            text-align: center;
            margin-top: 30px;
            color: #64748b;
            font-size: 0.85em;
        }

        .footer a {
            color: #3b82f6;
            text-decoration: none;
            transition: color 0.2s;
        }

        .footer a:hover {
            color: #22d3ee;
            text-decoration: underline;
        }

        .legend-box {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
            color: #cbd5e1;
        }

        .legend-color {
            width: 20px;
            height: 4px;
            border-radius: 2px;
        }

        .medium-description {
            text-align: center;
            padding: 10px 20px;
            background: rgba(15, 23, 42, 0.4);
            border-radius: 10px;
            margin-bottom: 15px;
            color: #94a3b8;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 1.6em;
            }
            
            .info-cards {
                grid-template-columns: repeat(2, 1fr);
            }
            
            select {
                min-width: 180px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ”¬ Optical Tweezers Microrheology</h1>
        <p class="subtitle">Probe viscoelastic properties through Brownian motion analysis</p>

        <div class="top-controls">
            <div class="control-group">
                <label for="medium-select">Select Medium:</label>
                <select id="medium-select">
                    <option value="water">Water (Newtonian)</option>
                    <option value="glycerol50">50% Glycerol</option>
                    <option value="glycerol80">80% Glycerol</option>
                    <option value="polymer_weak">Dilute Polymer (PEO 0.1%)</option>
                    <option value="polymer_medium">Semi-dilute Polymer (PEO 1%)</option>
                    <option value="polymer_strong">Entangled Polymer (PEO 5%)</option>
                    <option value="gel_weak">Weak Gel (Agarose 0.1%)</option>
                    <option value="gel_strong">Strong Gel (Agarose 1%)</option>
                </select>
            </div>
        </div>

        <div id="medium-desc" class="medium-description">
            Pure viscous fluid â€” G' â‰ˆ 0, only viscous dissipation
        </div>

        <div class="info-cards">
            <div class="info-card gprime">
                <div class="label">G' (Storage) @ 1 rad/s</div>
                <div class="value" id="gprime-value">0.000 Pa</div>
            </div>
            <div class="info-card gdoubleprime">
                <div class="label">G'' (Loss) @ 1 rad/s</div>
                <div class="value" id="gdoubleprime-value">0.001 Pa</div>
            </div>
            <div class="info-card eta">
                <div class="label">|Î·*| (Complex Viscosity)</div>
                <div class="value" id="eta-value">0.001 PaÂ·s</div>
            </div>
            <div class="info-card tau">
                <div class="label">Ï„ (Relaxation Time)</div>
                <div class="value" id="tau-value">â€” s</div>
            </div>
        </div>

        <div class="instructions">
            <h3>ðŸ“‹ Understanding the Simulation:</h3>
            <ul>
                <li><strong>Top-left:</strong> Trapped bead showing Brownian motion (diffusion changes with medium)</li>
                <li><strong>Top-right:</strong> <code>G'(Ï‰)</code> and <code>G''(Ï‰)</code> â€” storage and loss moduli vs frequency</li>
                <li><strong>Bottom-left:</strong> Mean Square Displacement (MSD) â€” slope indicates diffusion behavior</li>
                <li><strong>Bottom-right:</strong> <code>|Î·*(Ï‰)|</code> â€” complex viscosity vs frequency</li>
                <li>Try switching between <strong>Newtonian</strong> (water) and <strong>viscoelastic</strong> (polymer/gel) media!</li>
            </ul>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            Loading simulation... (This may take 10-30 seconds on first load)
        </div>

        <div id="plot-area"></div>

        <div class="legend-box">
            <div class="legend-item">
                <div class="legend-color" style="background: #22c55e;"></div>
                <span>G' (Storage Modulus)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #f97316;"></div>
                <span>G'' (Loss Modulus)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #a855f7;"></div>
                <span>|Î·*| (Complex Viscosity)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #06b6d4;"></div>
                <span>MSD (Mean Square Displacement)</span>
            </div>
        </div>

        <div class="footer">
            <p>2 Âµm silica bead â€¢ 1 pN/Âµm trap stiffness â€¢ 293 K â€¢ Maxwell viscoelastic model</p>
            <p>Built with PyScript | <a href="https://github.com/aliazadbakht/OpenFlexureOT" target="_blank">View on GitHub</a></p>
        </div>
    </div>

    <script type="py" config='{"packages": ["numpy", "matplotlib"]}'>
import numpy as np
import matplotlib
matplotlib.use('module://matplotlib_pyodide.wasm_backend')
import matplotlib.pyplot as plt
from js import document
import asyncio

# Physical constants
k_B = 1.380649e-23  # Boltzmann constant

# Medium definitions with rheological properties
MEDIA = {
    'water': {
        'name': 'Water (Newtonian)',
        'description': 'Pure viscous fluid â€” G\' â‰ˆ 0, only viscous dissipation',
        'eta': 0.001,      # PaÂ·s (viscosity)
        'G0': 0,           # Pa (elastic modulus)
        'tau': 0,          # s (relaxation time)
        'color': '#3b82f6',
        'type': 'newtonian'
    },
    'glycerol50': {
        'name': '50% Glycerol',
        'description': 'Higher viscosity Newtonian fluid â€” slower diffusion',
        'eta': 0.006,
        'G0': 0,
        'tau': 0,
        'color': '#8b5cf6',
        'type': 'newtonian'
    },
    'glycerol80': {
        'name': '80% Glycerol',
        'description': 'Very viscous Newtonian fluid â€” much slower Brownian motion',
        'eta': 0.06,
        'G0': 0,
        'tau': 0,
        'color': '#a855f7',
        'type': 'newtonian'
    },
    'polymer_weak': {
        'name': 'Dilute Polymer (PEO 0.1%)',
        'description': 'Weak viscoelastic â€” Maxwell fluid with short relaxation time',
        'eta': 0.003,
        'G0': 0.5,         # Pa
        'tau': 0.01,       # s
        'color': '#10b981',
        'type': 'maxwell'
    },
    'polymer_medium': {
        'name': 'Semi-dilute Polymer (PEO 1%)',
        'description': 'Moderate viscoelasticity â€” G\' and G\'\' crossover visible',
        'eta': 0.01,
        'G0': 5,           # Pa
        'tau': 0.1,        # s
        'color': '#14b8a6',
        'type': 'maxwell'
    },
    'polymer_strong': {
        'name': 'Entangled Polymer (PEO 5%)',
        'description': 'Strong viscoelastic response â€” significant elasticity',
        'eta': 0.05,
        'G0': 50,          # Pa
        'tau': 1.0,        # s
        'color': '#0d9488',
        'type': 'maxwell'
    },
    'gel_weak': {
        'name': 'Weak Gel (Agarose 0.1%)',
        'description': 'Soft viscoelastic solid â€” G\' > G\'\' at low frequencies',
        'eta': 0.002,
        'G0': 10,          # Pa
        'tau': 10,         # s
        'color': '#f59e0b',
        'type': 'maxwell'
    },
    'gel_strong': {
        'name': 'Strong Gel (Agarose 1%)',
        'description': 'Stiff viscoelastic solid â€” G\' dominant across all frequencies',
        'eta': 0.005,
        'G0': 500,         # Pa
        'tau': 100,        # s
        'color': '#ef4444',
        'type': 'maxwell'
    }
}


def calculate_moduli(medium, omega):
    """Calculate G'(omega) and G''(omega) for a given medium"""
    eta = medium['eta']
    G0 = medium['G0']
    tau = medium['tau']
    medium_type = medium['type']
    
    if medium_type == 'newtonian':
        # Newtonian: G' = 0, G'' = omega * eta
        Gprime = np.zeros_like(omega)
        Gdoubleprime = omega * eta
    else:
        # Maxwell model
        omega_tau = omega * tau
        omega_tau2 = omega_tau ** 2
        denom = 1 + omega_tau2
        
        Gprime = G0 * omega_tau2 / denom
        Gdoubleprime = G0 * omega_tau / denom + omega * eta * 0.1
    
    return Gprime, Gdoubleprime


def calculate_complex_viscosity(Gprime, Gdoubleprime, omega):
    """Calculate complex viscosity |eta*| = |G*|/omega"""
    Gstar = np.sqrt(Gprime**2 + Gdoubleprime**2)
    eta_star = np.divide(Gstar, omega, out=np.zeros_like(Gstar), where=omega!=0)
    return eta_star


class MicrorheologySimulation:
    def __init__(self):
        # Physical parameters
        self.T = 293.15              # Temperature (K)
        self.d_p = 2.0e-6            # 2 Âµm particle diameter
        self.r_p = self.d_p / 2.0
        self.k_trap = 1.0e-6         # Trap stiffness (N/m) = 1 pN/Âµm
        self.dt = 0.0005             # Time step (s)
        
        # Current medium
        self.medium = MEDIA['water']
        
        # Particle state
        self.x = 0.0
        self.y = 0.0
        
        # Data storage
        self.position_history = []
        self.msd_data = {'tau': [], 'msd': []}
        
    def set_medium(self, medium_key):
        """Change the medium and reset simulation"""
        self.medium = MEDIA[medium_key]
        self.x = 0.0
        self.y = 0.0
        self.position_history = []
        self.msd_data = {'tau': [], 'msd': []}
        
    def run_burst(self, n_steps=200):
        """Run multiple simulation steps"""
        eta = self.medium['eta']
        G0 = self.medium['G0']
        tau = self.medium['tau']
        
        gamma = 6 * np.pi * eta * self.r_p
        D = (k_B * self.T) / gamma
        sigma = np.sqrt(2 * D * self.dt)
        
        # Memory effect for viscoelastic media
        memory_factor = 1.0
        if self.medium['type'] == 'maxwell' and tau > 0:
            memory_factor = 1.0 / (1.0 + G0 / (eta / tau + 1e-10))
        
        effective_sigma = sigma * np.sqrt(memory_factor)
        
        # Pre-generate noise
        noise_x = np.random.normal(0, effective_sigma, n_steps)
        noise_y = np.random.normal(0, effective_sigma, n_steps)
        
        x_history = np.zeros(n_steps)
        y_history = np.zeros(n_steps)
        
        curr_x = self.x
        curr_y = self.y
        
        k_gamma_dt = (self.k_trap / gamma) * self.dt
        
        for i in range(n_steps):
            # Langevin equation with trap
            curr_x = curr_x - (curr_x * k_gamma_dt) + noise_x[i]
            curr_y = curr_y - (curr_y * k_gamma_dt) + noise_y[i]
            
            x_history[i] = curr_x
            y_history[i] = curr_y
        
        self.x = curr_x
        self.y = curr_y
        
        # Store for MSD calculation
        for i in range(n_steps):
            self.position_history.append((x_history[i], y_history[i]))
        
        # Keep limited history
        if len(self.position_history) > 5000:
            self.position_history = self.position_history[-5000:]
        
        return x_history, y_history
    
    def calculate_msd(self):
        """Calculate Mean Square Displacement"""
        if len(self.position_history) < 100:
            return
        
        history = self.position_history
        n = len(history)
        
        lag_times = [1, 2, 5, 10, 20, 50, 100, 200, 500, 1000]
        
        tau_list = []
        msd_list = []
        
        for lag in lag_times:
            if lag >= n:
                continue
            
            sum_sq_disp = 0
            count = 0
            
            step = max(1, lag // 10)
            for i in range(0, n - lag, step):
                dx = history[i + lag][0] - history[i][0]
                dy = history[i + lag][1] - history[i][1]
                sum_sq_disp += dx**2 + dy**2
                count += 1
            
            if count > 0:
                tau_list.append(lag * self.dt)
                msd_list.append((sum_sq_disp / count) * 1e12)  # Convert to ÂµmÂ²
        
        self.msd_data = {'tau': tau_list, 'msd': msd_list}


# Create simulation instance
sim = MicrorheologySimulation()

# Generate frequency array for rheology plots
omega = np.logspace(-2, 3, 100)  # 0.01 to 1000 rad/s

# Create figure with subplots
fig = plt.figure(figsize=(13, 8), facecolor='#1e293b')
gs = fig.add_gridspec(2, 2, hspace=0.35, wspace=0.3)

# Set dark background for all axes
for ax in [fig.add_subplot(gs[i, j]) for i in range(2) for j in range(2)]:
    ax.remove()

# Plot 1: Bead visualization (top-left)
ax_bead = fig.add_subplot(gs[0, 0])
ax_bead.set_facecolor('#0f172a')
ax_bead.set_xlim(-3, 3)
ax_bead.set_ylim(-3, 3)
ax_bead.set_aspect('equal')
ax_bead.set_title('Trapped Bead (Brownian Motion)', color='#e2e8f0', fontsize=11, fontweight='bold')
ax_bead.set_xlabel('x (Âµm)', color='#94a3b8')
ax_bead.set_ylabel('y (Âµm)', color='#94a3b8')
ax_bead.tick_params(colors='#64748b')
ax_bead.grid(True, alpha=0.2, color='#475569')
for spine in ax_bead.spines.values():
    spine.set_color('#475569')

# Trap zone circle
trap_circle = plt.Circle((0, 0), 1.5, color='#ef4444', fill=False, 
                          linestyle='--', lw=1.5, alpha=0.5)
ax_bead.add_patch(trap_circle)

# Laser focus
laser_circle = plt.Circle((0, 0), 0.15, color='#ef4444', alpha=0.4)
ax_bead.add_patch(laser_circle)

# Particle
particle = plt.Circle((0, 0), sim.d_p*1e6/2, color='#3b82f6', alpha=0.9)
ax_bead.add_patch(particle)

# Trail
trail_line, = ax_bead.plot([], [], '-', lw=0.8, alpha=0.4, color='#3b82f6')

# Plot 2: G' and G'' vs frequency (top-right)
ax_moduli = fig.add_subplot(gs[0, 1])
ax_moduli.set_facecolor('#0f172a')
ax_moduli.set_title("Dynamic Moduli G'(Ï‰) and G''(Ï‰)", color='#e2e8f0', fontsize=11, fontweight='bold')
ax_moduli.set_xlabel('Ï‰ (rad/s)', color='#94a3b8')
ax_moduli.set_ylabel("G', G'' (Pa)", color='#94a3b8')
ax_moduli.set_xscale('log')
ax_moduli.set_yscale('log')
ax_moduli.tick_params(colors='#64748b')
ax_moduli.grid(True, alpha=0.2, color='#475569', which='both')
for spine in ax_moduli.spines.values():
    spine.set_color('#475569')

gprime_line, = ax_moduli.plot([], [], '-', lw=2.5, color='#22c55e', label="G' (Storage)")
gdoubleprime_line, = ax_moduli.plot([], [], '-', lw=2.5, color='#f97316', label="G'' (Loss)")
ax_moduli.legend(loc='lower right', facecolor='#1e293b', edgecolor='#475569', 
                 labelcolor='#e2e8f0', fontsize=9)

# Plot 3: MSD (bottom-left)
ax_msd = fig.add_subplot(gs[1, 0])
ax_msd.set_facecolor('#0f172a')
ax_msd.set_title('Mean Square Displacement', color='#e2e8f0', fontsize=11, fontweight='bold')
ax_msd.set_xlabel('Ï„ (s)', color='#94a3b8')
ax_msd.set_ylabel('MSD (ÂµmÂ²)', color='#94a3b8')
ax_msd.set_xscale('log')
ax_msd.set_yscale('log')
ax_msd.tick_params(colors='#64748b')
ax_msd.grid(True, alpha=0.2, color='#475569', which='both')
for spine in ax_msd.spines.values():
    spine.set_color('#475569')

msd_scatter = ax_msd.scatter([], [], s=50, c='#06b6d4', edgecolors='white', linewidths=0.5)
msd_line, = ax_msd.plot([], [], '-', lw=1.5, color='#06b6d4', alpha=0.5)

# Plot 4: Complex viscosity (bottom-right)
ax_eta = fig.add_subplot(gs[1, 1])
ax_eta.set_facecolor('#0f172a')
ax_eta.set_title('Complex Viscosity |Î·*(Ï‰)|', color='#e2e8f0', fontsize=11, fontweight='bold')
ax_eta.set_xlabel('Ï‰ (rad/s)', color='#94a3b8')
ax_eta.set_ylabel('|Î·*| (PaÂ·s)', color='#94a3b8')
ax_eta.set_xscale('log')
ax_eta.set_yscale('log')
ax_eta.tick_params(colors='#64748b')
ax_eta.grid(True, alpha=0.2, color='#475569', which='both')
for spine in ax_eta.spines.values():
    spine.set_color('#475569')

eta_line, = ax_eta.plot([], [], '-', lw=2.5, color='#a855f7', label='|Î·*|')
ax_eta.legend(loc='upper right', facecolor='#1e293b', edgecolor='#475569', 
              labelcolor='#e2e8f0', fontsize=9)

# Data storage for trail
trail_x = []
trail_y = []

# Frame counter
frame_count = [0]
current_medium = ['water']


def update_rheology_plots():
    """Update the rheology plots for current medium"""
    medium = sim.medium
    
    # Calculate moduli
    Gprime, Gdoubleprime = calculate_moduli(medium, omega)
    eta_star = calculate_complex_viscosity(Gprime, Gdoubleprime, omega)
    
    # Update G' and G'' plot
    gprime_line.set_data(omega, np.maximum(Gprime, 1e-10))
    gdoubleprime_line.set_data(omega, np.maximum(Gdoubleprime, 1e-10))
    
    # Adjust y-axis limits
    all_values = np.concatenate([Gprime[Gprime > 0], Gdoubleprime[Gdoubleprime > 0]])
    if len(all_values) > 0:
        ymin = max(1e-6, np.min(all_values) * 0.1)
        ymax = np.max(all_values) * 10
        ax_moduli.set_ylim(ymin, ymax)
    ax_moduli.set_xlim(1e-2, 1e3)
    
    # Update viscosity plot
    eta_line.set_data(omega, np.maximum(eta_star, 1e-10))
    valid_eta = eta_star[eta_star > 0]
    if len(valid_eta) > 0:
        ax_eta.set_ylim(np.min(valid_eta) * 0.1, np.max(valid_eta) * 10)
    ax_eta.set_xlim(1e-2, 1e3)
    
    # Update info cards
    Gprime_1, Gdoubleprime_1 = calculate_moduli(medium, np.array([1.0]))
    eta_star_1 = calculate_complex_viscosity(Gprime_1, Gdoubleprime_1, np.array([1.0]))
    
    document.getElementById("gprime-value").innerHTML = f"{Gprime_1[0]:.4f} Pa"
    document.getElementById("gdoubleprime-value").innerHTML = f"{Gdoubleprime_1[0]:.4f} Pa"
    document.getElementById("eta-value").innerHTML = f"{eta_star_1[0]:.4f} PaÂ·s"
    
    if medium['tau'] > 0:
        document.getElementById("tau-value").innerHTML = f"{medium['tau']} s"
    else:
        document.getElementById("tau-value").innerHTML = "â€” s"
    
    # Update description
    document.getElementById("medium-desc").innerHTML = medium['description']
    
    # Update particle color
    particle.set_color(medium['color'])


def animate(frame):
    global trail_x, trail_y
    
    # Check for medium change
    select_elem = document.getElementById("medium-select")
    selected = select_elem.value
    
    if selected != current_medium[0]:
        current_medium[0] = selected
        sim.set_medium(selected)
        trail_x = []
        trail_y = []
        update_rheology_plots()
    
    # Run physics simulation
    x_burst, y_burst = sim.run_burst(n_steps=100)
    
    # Convert to microns for display
    x_um = x_burst * 1e6
    y_um = y_burst * 1e6
    
    # Update trail
    trail_x.extend(x_um.tolist())
    trail_y.extend(y_um.tolist())
    
    if len(trail_x) > 1000:
        trail_x = trail_x[-1000:]
        trail_y = trail_y[-1000:]
    
    # Update particle position
    particle.center = (sim.x * 1e6, sim.y * 1e6)
    
    # Update trail line
    trail_line.set_data(trail_x, trail_y)
    trail_line.set_color(sim.medium['color'])
    
    # Calculate and update MSD (every 10 frames)
    if frame_count[0] % 10 == 0:
        sim.calculate_msd()
        
        if len(sim.msd_data['tau']) > 0:
            tau_arr = np.array(sim.msd_data['tau'])
            msd_arr = np.array(sim.msd_data['msd'])
            
            # Update scatter plot
            msd_scatter.set_offsets(np.column_stack([tau_arr, msd_arr]))
            msd_line.set_data(tau_arr, msd_arr)
            
            # Adjust axes
            if len(tau_arr) > 1:
                ax_msd.set_xlim(tau_arr.min() * 0.5, tau_arr.max() * 2)
                valid_msd = msd_arr[msd_arr > 0]
                if len(valid_msd) > 0:
                    ax_msd.set_ylim(valid_msd.min() * 0.5, valid_msd.max() * 2)
    
    frame_count[0] += 1
    fig.canvas.draw()


# Initialize
print("=" * 55)
print("OPTICAL TWEEZERS MICRORHEOLOGY SIMULATION")
print("=" * 55)
print("â€¢ Select different media from the dropdown menu")
print("â€¢ Watch how Brownian motion changes with viscosity")
print("â€¢ Compare Newtonian fluids (G' = 0) vs viscoelastic media")
print("â€¢ Observe G'(Ï‰), G''(Ï‰), and |Î·*(Ï‰)| frequency response")
print("=" * 55)

# Hide loading message
document.getElementById("loading").style.display = "none"

# Initial rheology plot update
update_rheology_plots()

plt.tight_layout()

# Animation loop
async def run_animation():
    frame = 0
    while True:
        animate(frame)
        frame += 1
        await asyncio.sleep(0.03)  # ~33 FPS

asyncio.create_task(run_animation())
plt.show()
    </script>
</body>
</html>